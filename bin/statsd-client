#!/usr/bin/env ruby

require 'ideeli/statsd'

def usage
  puts %{usage: statsd-client [action] [[namespace.]metric] [arguments]

  valid actions:

      statsd-client increment [namespace.]metric [sample-rate = 1]
      statsd-client decrement [namespace.]metric [sample-rate = 1]
      statsd-client count [namespace.]metric count [sample-rate = 1]
      statsd-client timing [namespace.]metric time [sample-rate = 1]

  environment variables:

      STATSD_HOST       statsd host to log to
      STATSD_PORT       statsd port to log to
      STATSD_CONFIG     yaml namespace configuration

  example:

      STATSD_HOST=statsd.ideeli.com statsd-client increment deployment

  }

  exit 1
end

def main
  usage if ARGV.empty?

  # third and fourth argument must be numeric if present
  [2, 3].each { |i| ARGV[i] = ARGV[i].to_i if ARGV[i] }

  case action = ARGV.shift
  when 'increment'; Ideeli::Statsd::Client.send(action.to_sym, *ARGV)
  when 'decrement'; Ideeli::Statsd::Client.send(action.to_sym, *ARGV)
  when 'count'    ; Ideeli::Statsd::Client.send(action.to_sym, *ARGV)
  when 'timing'   ; Ideeli::Statsd::Client.send(action.to_sym, *ARGV)
  else raise ArgumentError, "Invalid action: #{action}"
  end
rescue ArgumentError => e
  puts e
  usage
rescue => e
  puts e
end

Ideeli::Statsd::Client.configure do |conf|
  conf.host      = ENV['STATSD_HOST'] if ENV['STATSD_HOST']
  conf.port      = ENV['STATSD_PORT'] if ENV['STATSD_PORT']
  conf.yaml_file = ENV['STATSD_CONFIG'] if ENV['STATSD_CONFIG']

  # Event metrics
  #   <node-type>.app.<application>.<metric>
  #
  unless (namespaces = [conf.node_type, conf.application].compact).empty?
    conf.namespaces << namespaces.join('.')
  end
end

main
